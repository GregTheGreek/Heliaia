{"code":"import { Command } from 'commander';\r\nimport ethers from 'ethers';\r\nimport express from 'express';\r\nimport ganache from 'ganache';\r\nimport readline from 'readline';\r\nconst program = new Command();\r\nprogram\r\n    .option('-r --rpc <url>', 'RPC URL to proxy to', 'http://localhost:8545/')\r\n    .option('-p --port <number>', 'Port number to listen on', '9545');\r\nprogram.parse(process.argv);\r\nconst options = program.opts();\r\nconst GANACHE_CONFIG = {\r\n    fork: {\r\n        url: options.rpc,\r\n    },\r\n    miner: {\r\n        blockTime: 1\r\n    },\r\n    logging: {\r\n        logger: {\r\n            log: () => { }\r\n        }\r\n    }\r\n};\r\nlet ac = new AbortController();\r\nconst rl = readline.createInterface({\r\n    input: process.stdin,\r\n    output: process.stdout\r\n});\r\nconst provider = new ethers.providers.JsonRpcProvider({ url: options.rpc });\r\nconst authSigner = new ethers.Wallet(ethers.utils.randomBytes(32));\r\nfunction isRelayResponseError(r) {\r\n    return r?.error !== undefined;\r\n}\r\nclass BundleProxy {\r\n    constructor(provider) {\r\n        this.baseProvider = provider;\r\n        this.provider = provider;\r\n    }\r\n    async rpcHandler(method, params) {\r\n        switch (method) {\r\n            case 'eth_sendRawTransaction':\r\n                return this.transactionHandler(params);\r\n            default:\r\n                return this.provider.send(method, params);\r\n        }\r\n    }\r\n    async transactionHandler(params) {\r\n        const tx = ethers.utils.parseTransaction(params[0]);\r\n        const bundle = await this.getBundle();\r\n        for (let i = bundle.length - 1; i >= 0; i--) {\r\n            if (bundle[i].from === tx.from && bundle[i].nonce === tx.nonce && bundle[i].hash !== tx.hash) {\r\n                if (i < bundle.length - 1) {\r\n                    console.log(\"Warning: Replacing TX from earlier in the bundle\");\r\n                }\r\n                bundle[i] = tx;\r\n                return this.provider.send('eth_sendRawTransaction', params);\r\n            }\r\n        }\r\n        bundle.push(tx);\r\n        showPrompt();\r\n        return this.provider.send('eth_sendRawTransaction', params);\r\n    }\r\n    async getBundle() {\r\n        if (this.bundle === undefined) {\r\n            this.provider = new ethers.providers.Web3Provider(ganache.provider(GANACHE_CONFIG));\r\n            console.log(`Created fork at block ${await this.provider.getBlockNumber()}`);\r\n            this.bundle = [];\r\n        }\r\n        return this.bundle;\r\n    }\r\n    revertFork() {\r\n        this.bundle = undefined;\r\n        this.provider = this.baseProvider;\r\n    }\r\n    async submitFork() {\r\n        if (this.bundle === undefined) {\r\n            return false;\r\n        }\r\n        const blockno = 1 + await this.baseProvider.getBlockNumber();\r\n        console.log(`Attempting to submit bundle at block number ${blockno}`);\r\n        const flashbotsProvider = await FlashbotsBundleProvider.create(this.baseProvider, authSigner);\r\n        const txresponse = await flashbotsProvider.sendBundle(this.bundle.map((tx) => ({\r\n            signedTransaction: ethers.utils.serializeTransaction(tx, { r: tx.r, s: tx.s, v: tx.v })\r\n        })), blockno);\r\n        if (isRelayResponseError(txresponse)) {\r\n            console.log(`Error submitting bundle: ${txresponse.error.message}`);\r\n            return false;\r\n        }\r\n        const sim = await txresponse.simulate();\r\n        if (isRelayResponseError(sim)) {\r\n            console.log(`Simulation produced an error: ${sim.error}`);\r\n        }\r\n        else {\r\n            console.log(`Simulation result: ${sim.firstRevert === undefined ? 'success' : 'failure'}`);\r\n        }\r\n        const status = await txresponse.wait();\r\n        switch (status) {\r\n            case FlashbotsBundleResolution.BundleIncluded:\r\n                console.log(\"Bundle mined!\");\r\n                this.revertFork();\r\n                return true;\r\n            case FlashbotsBundleResolution.AccountNonceTooHigh:\r\n                console.log(\"Failed to mine bundle: account nonce too high. Resetting fork.\");\r\n                this.revertFork();\r\n                return true;\r\n            case FlashbotsBundleResolution.BlockPassedWithoutInclusion:\r\n                console.log(\"Failed to include bundle in block; try again.\");\r\n                return false;\r\n        }\r\n    }\r\n}\r\nconst proxy = new BundleProxy(provider);\r\nconst app = express();\r\napp.use(express.json());\r\napp.post('/', async (req, res) => {\r\n    const { id, method, params } = req.body;\r\n    try {\r\n        const result = await proxy.rpcHandler(method, params);\r\n        res.json({\r\n            jsonrpc: \"2.0\",\r\n            id,\r\n            result\r\n        });\r\n    }\r\n    catch (e) {\r\n        if (e?.body !== undefined) {\r\n            const { error } = JSON.parse(e.body);\r\n            res.json({\r\n                jsonrpc: \"2.0\",\r\n                id,\r\n                error\r\n            });\r\n        }\r\n        else {\r\n            console.log(e);\r\n        }\r\n    }\r\n});\r\napp.listen(parseInt(options.port), () => {\r\n    console.log(`Listening on port ${options.port}`);\r\n});\r\nfunction showPrompt() {\r\n    ac.abort();\r\n    if (!proxy.bundle) {\r\n        return;\r\n    }\r\n    for (let i = 0; i < proxy.bundle?.length; i++) {\r\n        const tx = proxy.bundle[i];\r\n        console.log(`${i + 1}. ${tx.from} -> ${tx.to}`);\r\n    }\r\n    ac = new AbortController();\r\n    rl.question('(S)ubmit, (R)evert?', { signal: ac.signal }, handleResponse);\r\n}\r\nasync function handleResponse(response) {\r\n    switch (response.toLowerCase()) {\r\n        case 's':\r\n            const result = await proxy.submitFork();\r\n            if (!result) {\r\n                showPrompt();\r\n            }\r\n            break;\r\n        case 'r':\r\n            console.log(\"Reverting.\");\r\n            proxy.revertFork();\r\n            break;\r\n        default:\r\n            showPrompt();\r\n            break;\r\n    }\r\n}\r\n//# sourceMappingURL=index.js.map","references":["/Users/gregmarkou/code/github.com/GregTheGreek/Heliaia/node_modules/commander/typings/index.d.ts","/Users/gregmarkou/code/github.com/GregTheGreek/Heliaia/node_modules/ethers/lib/index.d.ts","/Users/gregmarkou/code/github.com/GregTheGreek/Heliaia/node_modules/@types/express/ts4.0/index.d.ts","/Users/gregmarkou/code/github.com/GregTheGreek/Heliaia/node_modules/ganache/index.d.ts"],"map":"{\"version\":3,\"file\":\"index.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/index.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/gregmarkou/code/github.com/GregTheGreek/Heliaia/index.d.ts","writeByteOrderMark":false,"text":"export {};\r\n"}}
